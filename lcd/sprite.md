# スプライト(OBJ)

スプライトとは8x8～64x64サイズの画像を最大128個まで表示し、シューティングゲームでいう自機や弾、RPGでいう主人公キャラなどに使います。

## 概要

1画面あたり最大128個のOBJ（大きさは64×64ドットまで任意）を表示することができます。

8×8ドットの小さなサイズなら1行に最大128個のOBJを表示することができます。

## 1行に同時に表示可能なスプライトの数

1行あたり、OBJをレンダリングするのに使えるCPUサイクルの合計は

[LCD制御レジスタ](./lcd_control.md)のbit5("H-Blank Interval Free" bit)が

- 0のとき: 1210  (=304×4-6)
- 1のとき: 954   (=240×4-6)

となります。

またOBJのレンダリングに必要なサイクルは、OBJのX方向のピクセルサイズをnとすると次のようになります

サイクル | OBJ Type | OBJ Type Screen Pixel Range
-- | -- | -- 
n*1 cycles    | Normal OBJs           | 8..64 pixels
10+n*2 cycles | Rotation/Scaling OBJs | 8..64 pixels   (area clipped)
10+n*2 cycles | Rotation/Scaling OBJs | 16..128 pixels (double size)

プログラマはこれらの情報を用いて、OBJのレンダリングが間に合うように1行に表示するOBJを調整する必要があります。

1行あたりの最大OBJ数は、表示されているOBJよりも優先度の高い非表示（画面外）OBJの影響も受けます。

これを避けるには、表示したいOBJをなるべくOAMの前方に持ってきてください。

OBJ0が最も優先度が高く、OBJ127が最も優先度が低くなっています。

プログラムがOBJをOAMの固定位置にあることを前提としているなどの理由でそれができない場合、少なくとも、伸縮回転を無効にして、表示されていないOBJのサイズを8x8に設定することで余計な負荷を減らすことができます。

## VRAM - スプライトのタイルデータ

OBJは8×8のタイル単位で構成されています。

ただしOBJのタイルデータは背景のタイルデータとは別のメモリ領域に格納されています。

BGMode0-2では `0x0601_0000-0601_7fff`(32KB) に、BGMode3-5では `0x0601_4000-0601_7fff`(16KB)に格納されています。

このOBJタイルデータ用のメモリ領域に、何枚のタイルを格納できるかは、メモリ領域のサイズ(16KB or 32KB)だけでなく、OBJの色深度にも依存しており、最小で256タイル、最大で1024タイル格納できます。

## OAM - スプライトのプロパティ

OAMは`0x0700_0000-0700_03ff`にあります。 サイズは1KBです。

このメモリ領域には、128個のOBJのそれぞれの位置、サイズ、色深度などのスプライトの使用に必要な属性が格納されています。

さらに、32個のOBJに対する伸縮回転パラメータが格納されています。

### OAM

OAMはOBJ0からOBJ127まで分けられています。各エントリは2バイトのプロパティが3つあるので6バイトですが、

- OBJ0: 0x0700_0000
- OBJ1: 0x0700_0008
- OBJ${N}: 0x0700_0000 + 8×N

のように8バイトごとに配置されていることに注意してください。

後で述べますが、`0x0700_0006`, `0x0700_000e`, `0x0700_0016`のような空白の場所は、OBJの伸縮回転パラメータのための領域であり、これらはOAMのOBJとは結びついていません。

#### OBJ Attribute 0 (R/W)

 bit  |  内容
---- | ----
0-7 | Y座標 (0-255)
8 | 伸縮回転フラグ(0=無効, 1=有効)
9 | サイズ2倍フラグ(伸縮回転フラグが1のとき, 1=2倍) or OBJ非表示フラグ(伸縮回転フラグが0のとき, 1=非表示)
10-11 | OBJモード (0=通常, 1=半透明, 2=OBJウィンドウ, 3=指定不可)
12    | OBJモザイク (0=無効, 1=有効)
13    | カラーパレット (0=16色/16パレット, 1=256色/1パレット)
14-15 | OBJ Shape (0=正方形, 1=横長, 2=縦長, 3=指定不可)

注意: 大きいOBJ(Y方向のサイズがサイズ2倍フラグによって128px)が Y>128 に存在するとき Y>-128として扱われます。 つまりOBJは画面の上の方に表示され、下の方には表示されません。

#### OBJ Attribute 1 (R/W)

**伸縮回転が有効(Attr0のbit8が1)**

 bit  |  内容
---- | ----
0-8 | X座標 (0-511)
9-13 | 伸縮回転パラメータ番号 (0-31)
14-15 | OBJサイズ (0-3, Attr0のOBJ Shapeに依存)

**伸縮回転が無効(Attr0のbit8が0)**

 bit  |  内容
---- | ----
0-8 | X座標 (0-511)
9-11 | 使用しない
12 | X反転
13 | Y反転
14-15 | OBJサイズ (0-3, Attr0のOBJ Shapeに依存)

**OBJサイズ(bit14-15)**

OBJサイズ | 正方形 | 横長 | 縦長
-- | -- | -- | --
0    | 8x8    | 16x8       | 8x16
1    | 16x16  | 32x8       | 8x32
2    | 32x32  | 32x16      | 16x32
3    | 64x64  | 64x32      | 32x64

#### OBJ Attribute 2 (R/W)

 bit  |  内容
---- | ----
0-9 | タイル番号 (0-1023)
10-11 | 対BG優先度 (0-3; 0=Highest)
12-15 | パレット番号 (0-15) (256色/1パレットのときは使用しない)

#### OBJモード

OBJモード(Attr0のbit10-11)は

- 通常(0)
- 半透明(1)
- OBJウィンドウ(2)

のどれかになります。

半透明モードのとき、OBJはBLDCNTレジスタの値に関係なくアルファブレンドの第1ターゲットとして使われます。詳しくは[ブレンド](./brend.md)を参照してください。

OBJウィンドウモードのときは、OBJは表示されず、代わりに透明でないピクセルはOBJウィンドウのマスクとして使用されます。詳しくは[LCD制御レジスタ](./lcd_control.md)と[WINOUT](./window.md)を見てください。

#### OBJのタイル番号

Attr2のbit0-9で指定するタイル番号は通常0-1023まで指定可能ですが、場合によっては制限が加わる時があります。

- 256色/1パレットのとき: 偶数のタイル番号のみを使用することができ、タイル番号の下位ビットは0にする必要があります。 2次元マッピングモード(後述)では、このビットは完全に無視されます。
- BGモード3-5のときつまりビットマップモードのとき: タイル番号は512から1023までしか指定できません。これはOBJの下位16KBがフレームバッファとして使われているからです。0-511を指定したときは無視され非表示になります。

#### 対BG優先度

Attr2の対BG優先度が[BG制御レジスタ](./bg_control.md)のbit0-1で指定するBGレイヤの優先度と同じ場合、OBJのほうが優先され、そのBGレイヤの上に表示されます。

OBJ同士の優先度と混同しないように注意してください。

例として、OBJ0の対BG優先度=1 で OBJ1の対BG優先度=0 の場合を考えてみましょう 

[1行に同時に表示可能なスプライトの数](#1行に同時に表示可能なスプライトの数)のところでも述べたようにOBJ同士ではOBJ0が最も優先度が高いです。

なのでOBJ同士が重なった時は OBJ0 > OBJ1 ですが、対BG優先度を見ると BG0 > OBJ0、OBJ1 > BG0となり奇妙なことになってしまいます。

### 伸縮回転パラメータ

上で述べたようにOAMの各エントリの間には空白の領域がありました。 これらの 128×16bit はOBJの伸縮回転パラメータを格納するのに使われます。

#### PA,PB,PC,PD (R/W)

4つの16bitパラメータ(PA,PB,PC,PD)で各OBJの伸縮回転に関するプロパティを定義しています。

- 1st Group: PA=07000006, PB=0700000E, PC=07000016, PD=0700001E
- 2nd Group: PA=07000026, PB=0700002E, PC=07000036, PD=0700003E
- ...

のように配置されています。

伸縮回転パラメータ用のメモリ領域は全部で 128×16bitであり、1つのOBJにつき4×16bitなので全部で 32 OBJ の伸縮回転パラメータを持つことができます。

伸縮回転を使用する各OBJは、上記の32のパラメータグループの中から任意のものを選択することができます。

これはAttr1のbit9-13でOBJと紐づけられます。

個別のPA,PB,PC,PD値の意味は[BGの場合](bg_rotation_scaling.md#伸縮回転パラメータ)と同じです。

#### 基準点

OBJの伸縮回転時の基準点はOBJの座標に等しくなります。

またOBJを回転させる際はOBJの真ん中を軸として回転させることになります。例えば 8×32の場合、(4, 16)が軸になって回転します。

#### サイズ2倍フラグ (Attr0のbit9)

これは伸縮回転が有効なOBJに対するフラグです。

**フラグが0**

スプライトを回転させて、(回転していない場合の)通常サイズの長方形の領域の内側に表示します。回転されたスプライトの端がその領域の外に出てしまうと、その端は見えなくなってしまいます。

**フラグが1**

スプライトを回転させた後，(回転していない場合の)2倍のサイズのの矩形領域の内側に表示します．これにより，回転したスプライトの端が通常のサイズの範囲外に出てしまっても，スプライトの端が見えるようになります。

ただし、例えば8x32ピクセルのスプライトを90度回転させた場合、サイズ2倍の領域は16×64と32に満たないので、スプライトの一部が切り取られてしまいます。

### OBJのマッピングモード

OBJタイルは8×8pxを1単位としており、より大きなOBJは複数の8×8タイルを組み合わせることによって表示することができます。

各OBJのX方向とY方向のサイズは、個別にOAMで定義することができ、8,16,32,64ピクセルから選択可能です。よって組み合わせによって正方形だったり長方形のOBJを設定可能です。

複数の8×8タイルを含むOBJを表示する場合、[LCD制御レジスタ](./lcd_control.md)のbit6で指定することで、以下の2つのマッピングモードのいずれかを使用することができます。いずれの場合も、左上のタイルのタイル番号をOAMメモリに指定しなければなりません。

#### 2次元マッピングモード

This mapping mode assumes that the 1024 OBJ tiles are arranged as a matrix of 32x32 tiles / 256x256 pixels (In 256 color mode: 16x32 tiles / 128x256 pixels). Ie. the upper row of this matrix contains tiles 00h-1Fh, the next row tiles 20h-3Fh, and so on.
For example, when displaying a 16x16 pixel OBJ, with tile number set to 04h; The upper row of the OBJ will consist of tile 04h and 05h, the next row of 24h and 25h. (In 256 color mode: 04h and 06h, 24h and 26h.)

#### 1次元マッピングモード

In this mode, tiles are mapped each after each other from 00h-3FFh.
Using the same example as above, the upper row of the OBJ will consist of tile 04h and 05h, the next row of tile 06h and 07h. (In 256 color mode: 04h and 06h, 08h and 0Ah.)