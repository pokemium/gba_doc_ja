# システム制御

## 0x0400_0204 - WAITCNT - Waitstate制御レジスタ (R/W)

このレジスタは、カートリッジのアクセスタイミングを設定するために使用されます。カートリッジのROMは `0x0800_0000`, `0x0a00_0000`, `0x0c00_0000` の3つのアドレス領域にミラーリングされており、これらの領域は WaitState0, WaitState1, WaitState2 と呼ばれています。

それぞれのエリアに異なるアクセスタイミングを割り当てることができます（これは、カートリッジに複数のROMチップが含まれていて、それぞれ異なるアクセスタイミングを持つ場合に便利です）。

 bit  |  内容
----- | -----
0-1   | SRAM Wait Control          (0..3 = 4,3,2,8 cycles)
2-3   | N0 - WaitState0 ファーストアクセス  (0..3 = 4,3,2,8 cycles)
4     | S0 - WaitState0 セカンドアクセス (0..1 = 2,1 cycles)
5-6   | N1 - WaitState1 ファーストアクセス  (0..3 = 4,3,2,8 cycles)
7     | S1 - WaitState1 セカンドアクセス (0..1 = 4,1 cycles)
8-9   | N2 - WaitState2 ファーストアクセス  (0..3 = 4,3,2,8 cycles)
10    | S2 - WaitState2 セカンドアクセス (0..1 = 8,1 cycles)
11-12 | PHI Terminal Output        (0..3 = Disable, 4.19MHz, 8.38MHz, 16.78MHz)
13    | 未使用
14    | Game Pak Prefetch Buffer (Pipe) (0=Disable, 1=Enable)
15    | Game Pak Type Flag  (Read Only) (0=GBA, 1=CGB) (IN35 signal)
16-31 | 未使用

WAITCNTは起動時には0x0000_0000です。

そしてその後、現在製造されているカートリッジでは `WAITCNT=0x0000_4317=0b0000_0000_0000_0000_0100_0011_0001_0111`となります。これは

- SRAM: 8サイクル
- WaitState0: 3サイクル(N0), 1サイクル(S0)
- WaitState1: 4サイクル(N1), 4サイクル(S1)
- WaitState2: 8サイクル(N2), 8サイクル(S2)

となります。

ファーストアクセス(ノンシーケンシャル)に要するサイクル(N0, N1, N2)とセカンドアクセス(シーケンシャル)に要するサイクル(S0, S1, S2)は、NとSサイクルのウェイトステートと呼ばれていて、実際のアクセス時間はウェイトステートのサイクルに1を加えたものです。

また、GamePakは16ビットのデータバスを使用しているため、32ビットアクセスは2つの16ビットアクセスに分割されます（最初の16bitがノンシーケンシャルであっても、残りの16bitは常にシーケンシャルです）。

NOTES: GBAはカートリッジROMの各128Kブロックの先頭にアクセスする際には強制的にノンシーケンシャルアクセスします。 またPHI端子出力(Gamepak BusのPHIピン)は無効にしてください。
